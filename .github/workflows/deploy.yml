name: Deploy

on:
  push:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/petrepopescu21/loctrec

jobs:
  build-and-push:
    name: build (${{ matrix.service }})
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        include:
          - service: auth
            context: services/auth
          - service: events
            context: services/events
          - service: tracker
            context: services/tracker
    steps:
      - uses: actions/checkout@v6

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}-${{ matrix.service }}:${{ github.sha }}
            ${{ env.IMAGE_PREFIX }}-${{ matrix.service }}:latest

  infra:
    name: infra
    runs-on: ubuntu-latest
    needs: build-and-push
    concurrency:
      group: deploy-aks
      cancel-in-progress: false
    permissions:
      contents: read
      packages: read
    steps:
      - uses: actions/checkout@v6

      - uses: azure/setup-kubectl@v4

      - uses: azure/setup-helm@v4

      - name: Write kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Add Helm repos
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo add istio https://istio-release.storage.googleapis.com/charts
          helm repo add jetstack https://charts.jetstack.io
          helm repo update

      - name: Install Istio
        run: |
          helm upgrade --install istio-base istio/base \
            -n istio-system --create-namespace --wait
          helm upgrade --install istiod istio/istiod \
            -n istio-system --wait --timeout 5m \
            --set pilot.resources.requests.cpu=25m \
            --set pilot.resources.requests.memory=64Mi \
            --set pilot.resources.limits.cpu=500m \
            --set pilot.resources.limits.memory=256Mi \
            --set pilot.autoscaleEnabled=false \
            --set pilot.replicaCount=1
          helm upgrade --install istio-ingressgateway istio/gateway \
            -n istio-system --wait --timeout 5m \
            --set resources.requests.cpu=10m \
            --set resources.requests.memory=32Mi \
            --set resources.limits.cpu=500m \
            --set resources.limits.memory=256Mi \
            --set autoscaling.enabled=false \
            --set replicaCount=1 \
            --set service.type=LoadBalancer
          kubectl label namespace default istio-injection=enabled --overwrite

      - name: Deploy PostgreSQL
        run: |
          helm upgrade --install postgres bitnami/postgresql \
            -f k8s/bootstrap/postgres-values.yaml \
            --wait --timeout 5m

      - name: Deploy Redis
        run: |
          helm upgrade --install redis bitnami/redis \
            -f k8s/bootstrap/redis-values.yaml \
            --wait --timeout 5m

      - name: Create GHCR pull secret
        run: |
          kubectl create secret docker-registry ghcr-secret \
            --docker-server=${{ env.REGISTRY }} \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.GITHUB_TOKEN }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Install cert-manager
        run: |
          helm upgrade --install cert-manager jetstack/cert-manager \
            -n cert-manager --create-namespace \
            --set crds.enabled=true \
            --wait --timeout 5m

      - name: Apply ClusterIssuer
        run: kubectl apply -f k8s/cert-manager/cluster-issuer.yaml

      - name: Apply Certificate
        run: kubectl apply -f k8s/cert-manager/certificate.yaml

      - name: Wait for certificate
        run: |
          kubectl wait --for=condition=Ready certificate/loctrec-tls \
            -n istio-system --timeout=300s

      - name: Apply Istio Gateway
        run: kubectl apply -f k8s/gateway-aks.yaml

  deploy-service:
    name: deploy (${{ matrix.service }})
    runs-on: ubuntu-latest
    needs: infra
    concurrency:
      group: deploy-aks-${{ matrix.service }}
      cancel-in-progress: false
    permissions:
      contents: read
      packages: read
    strategy:
      matrix:
        include:
          - service: auth
            chart: charts/auth
            extra_args: >-
              --set-string secrets.JWT_PRIVATE_KEY="${{ secrets.JWT_PRIVATE_KEY }}"
              --set-string secrets.JWT_PUBLIC_KEY="${{ secrets.JWT_PUBLIC_KEY }}"
              --set-string secrets.GOOGLE_CLIENT_ID="${{ secrets.GOOGLE_CLIENT_ID }}"
              --set-string secrets.GOOGLE_CLIENT_SECRET="${{ secrets.GOOGLE_CLIENT_SECRET }}"
              --set env.GOOGLE_REDIRECT_URI="https://20.103.7.163.nip.io/api/auth/oauth/google/callback"
          - service: events
            chart: charts/events
            extra_args: ""
          - service: tracker
            chart: charts/tracker
            extra_args: ""
    steps:
      - uses: actions/checkout@v6

      - name: Set app version
        run: |
          VERSION="${GITHUB_SHA::7}"
          sed -i "s/^appVersion:.*/appVersion: \"$VERSION\"/" ${{ matrix.chart }}/Chart.yaml

      - uses: azure/setup-kubectl@v4

      - uses: azure/setup-helm@v4

      - name: Write kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Deploy ${{ matrix.service }}
        run: |
          helm upgrade --install ${{ matrix.service }} ${{ matrix.chart }} \
            --set image.repository=${{ env.IMAGE_PREFIX }}-${{ matrix.service }} \
            --set image.tag=${{ github.sha }} \
            --set image.pullPolicy=Always \
            --set imagePullSecrets[0].name=ghcr-secret \
            ${{ matrix.extra_args }} \
            --wait --timeout 5m
