name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/petrepopescu21/loctrec

jobs:
  # ── Build (parallel) ──────────────────────────────────────────────
  build-auth:
    name: build auth
    runs-on: ubuntu-latest
    permissions: { contents: read, packages: write }
    steps:
      - uses: actions/checkout@v6
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/build-push-action@v6
        with:
          context: services/auth
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}-auth:${{ github.sha }}
            ${{ env.IMAGE_PREFIX }}-auth:latest
          cache-from: type=registry,ref=${{ env.IMAGE_PREFIX }}-auth:buildcache
          cache-to: type=registry,ref=${{ env.IMAGE_PREFIX }}-auth:buildcache,mode=max

  build-events:
    name: build events
    runs-on: ubuntu-latest
    permissions: { contents: read, packages: write }
    steps:
      - uses: actions/checkout@v6
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/build-push-action@v6
        with:
          context: services/events
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}-events:${{ github.sha }}
            ${{ env.IMAGE_PREFIX }}-events:latest
          cache-from: type=registry,ref=${{ env.IMAGE_PREFIX }}-events:buildcache
          cache-to: type=registry,ref=${{ env.IMAGE_PREFIX }}-events:buildcache,mode=max

  build-tracker:
    name: build tracker
    runs-on: ubuntu-latest
    permissions: { contents: read, packages: write }
    steps:
      - uses: actions/checkout@v6
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/build-push-action@v6
        with:
          context: services/tracker
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}-tracker:${{ github.sha }}
            ${{ env.IMAGE_PREFIX }}-tracker:latest
          cache-from: type=registry,ref=${{ env.IMAGE_PREFIX }}-tracker:buildcache
          cache-to: type=registry,ref=${{ env.IMAGE_PREFIX }}-tracker:buildcache,mode=max

  # ── Infra (parallel with builds) ─────────────────────────────────
  istio:
    name: istio
    runs-on: ubuntu-latest
    concurrency: { group: deploy-aks-istio, cancel-in-progress: false }
    permissions: { contents: read }
    steps:
      - uses: azure/setup-kubectl@v4
      - uses: azure/setup-helm@v4
      - name: Write kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" > ~/.kube/config
          chmod 600 ~/.kube/config
      - name: Install Istio
        run: |
          helm repo add istio https://istio-release.storage.googleapis.com/charts
          helm repo update istio
          helm upgrade --install istio-base istio/base \
            -n istio-system --create-namespace --wait
          helm upgrade --install istiod istio/istiod \
            -n istio-system --wait --timeout 5m \
            --set pilot.resources.requests.cpu=25m \
            --set pilot.resources.requests.memory=64Mi \
            --set pilot.resources.limits.cpu=500m \
            --set pilot.resources.limits.memory=256Mi \
            --set pilot.autoscaleEnabled=false \
            --set pilot.replicaCount=1
          helm upgrade --install istio-ingressgateway istio/gateway \
            -n istio-system --wait --timeout 5m \
            --set resources.requests.cpu=10m \
            --set resources.requests.memory=32Mi \
            --set resources.limits.cpu=500m \
            --set resources.limits.memory=256Mi \
            --set autoscaling.enabled=false \
            --set replicaCount=1 \
            --set service.type=LoadBalancer
          kubectl label namespace default istio-injection=enabled --overwrite

  postgres:
    name: postgres
    runs-on: ubuntu-latest
    concurrency: { group: deploy-aks-postgres, cancel-in-progress: false }
    permissions: { contents: read }
    steps:
      - uses: actions/checkout@v6
      - uses: azure/setup-kubectl@v4
      - uses: azure/setup-helm@v4
      - name: Write kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" > ~/.kube/config
          chmod 600 ~/.kube/config
      - name: Deploy PostgreSQL
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update bitnami
          helm upgrade --install postgres bitnami/postgresql \
            -f k8s/bootstrap/postgres-values.yaml \
            --wait --timeout 5m

  redis:
    name: redis
    runs-on: ubuntu-latest
    concurrency: { group: deploy-aks-redis, cancel-in-progress: false }
    permissions: { contents: read }
    steps:
      - uses: actions/checkout@v6
      - uses: azure/setup-kubectl@v4
      - uses: azure/setup-helm@v4
      - name: Write kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" > ~/.kube/config
          chmod 600 ~/.kube/config
      - name: Deploy Redis
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update bitnami
          helm upgrade --install redis bitnami/redis \
            -f k8s/bootstrap/redis-values.yaml \
            --wait --timeout 5m

  cert-manager:
    name: cert-manager
    runs-on: ubuntu-latest
    concurrency: { group: deploy-aks-cert-manager, cancel-in-progress: false }
    permissions: { contents: read }
    steps:
      - uses: actions/checkout@v6
      - uses: azure/setup-kubectl@v4
      - uses: azure/setup-helm@v4
      - name: Write kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" > ~/.kube/config
          chmod 600 ~/.kube/config
      - name: Install cert-manager
        run: |
          helm repo add jetstack https://charts.jetstack.io
          helm repo update jetstack
          helm upgrade --install cert-manager jetstack/cert-manager \
            -n cert-manager --create-namespace \
            --set crds.enabled=true \
            --wait --timeout 5m
          kubectl apply -f k8s/cert-manager/cluster-issuer.yaml
          kubectl apply -f k8s/cert-manager/certificate.yaml
          kubectl wait --for=condition=Ready certificate/loctrec-tls \
            -n istio-system --timeout=300s

  ghcr-secret:
    name: ghcr secret
    runs-on: ubuntu-latest
    concurrency: { group: deploy-aks-ghcr-secret, cancel-in-progress: false }
    permissions: { contents: read, packages: read }
    steps:
      - uses: azure/setup-kubectl@v4
      - name: Write kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" > ~/.kube/config
          chmod 600 ~/.kube/config
      - name: Create GHCR pull secret
        run: |
          kubectl create secret docker-registry ghcr-secret \
            --docker-server=${{ env.REGISTRY }} \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.GITHUB_TOKEN }} \
            --dry-run=client -o yaml | kubectl apply -f -

  gateway:
    name: gateway
    needs: [istio, cert-manager]
    runs-on: ubuntu-latest
    concurrency: { group: deploy-aks-gateway, cancel-in-progress: false }
    permissions: { contents: read }
    steps:
      - uses: actions/checkout@v6
      - uses: azure/setup-kubectl@v4
      - name: Write kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" > ~/.kube/config
          chmod 600 ~/.kube/config
      - name: Apply Istio Gateway
        run: kubectl apply -f k8s/gateway-aks.yaml

  # ── Deploy services (parallel, after builds + infra) ─────────────
  deploy-auth:
    name: deploy auth
    needs: [build-auth, istio, postgres, redis, ghcr-secret]
    runs-on: ubuntu-latest
    concurrency: { group: deploy-aks-auth, cancel-in-progress: false }
    permissions: { contents: read, packages: read }
    steps:
      - uses: actions/checkout@v6
      - uses: azure/setup-kubectl@v4
      - uses: azure/setup-helm@v4
      - name: Write kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" > ~/.kube/config
          chmod 600 ~/.kube/config
      - name: Set app version
        run: 'sed -i "s/^appVersion:.*/appVersion: \"${GITHUB_SHA::7}\"/" charts/auth/Chart.yaml'
      - name: Deploy auth
        run: |
          echo "${{ secrets.JWT_PRIVATE_KEY }}" > /tmp/jwt-private.pem
          echo "${{ secrets.JWT_PUBLIC_KEY }}" > /tmp/jwt-public.pem
          helm upgrade --install auth charts/auth \
            --set image.repository=${{ env.IMAGE_PREFIX }}-auth \
            --set image.tag=${{ github.sha }} \
            --set image.pullPolicy=Always \
            --set imagePullSecrets[0].name=ghcr-secret \
            --set-file secrets.JWT_PRIVATE_KEY=/tmp/jwt-private.pem \
            --set-file secrets.JWT_PUBLIC_KEY=/tmp/jwt-public.pem \
            --set-string secrets.GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }} \
            --set-string secrets.GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }} \
            --set env.GOOGLE_REDIRECT_URI=https://20.103.7.163.nip.io/api/auth/oauth/google/callback \
            --wait --timeout 5m
          rm -f /tmp/jwt-private.pem /tmp/jwt-public.pem

  deploy-events:
    name: deploy events
    needs: [build-events, istio, postgres, redis, ghcr-secret]
    runs-on: ubuntu-latest
    concurrency: { group: deploy-aks-events, cancel-in-progress: false }
    permissions: { contents: read, packages: read }
    steps:
      - uses: actions/checkout@v6
      - uses: azure/setup-kubectl@v4
      - uses: azure/setup-helm@v4
      - name: Write kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" > ~/.kube/config
          chmod 600 ~/.kube/config
      - name: Set app version
        run: 'sed -i "s/^appVersion:.*/appVersion: \"${GITHUB_SHA::7}\"/" charts/events/Chart.yaml'
      - name: Deploy events
        run: |
          helm upgrade --install events charts/events \
            --set image.repository=${{ env.IMAGE_PREFIX }}-events \
            --set image.tag=${{ github.sha }} \
            --set image.pullPolicy=Always \
            --set imagePullSecrets[0].name=ghcr-secret \
            --wait --timeout 5m

  deploy-tracker:
    name: deploy tracker
    needs: [build-tracker, istio, postgres, redis, ghcr-secret]
    runs-on: ubuntu-latest
    concurrency: { group: deploy-aks-tracker, cancel-in-progress: false }
    permissions: { contents: read, packages: read }
    steps:
      - uses: actions/checkout@v6
      - uses: azure/setup-kubectl@v4
      - uses: azure/setup-helm@v4
      - name: Write kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" > ~/.kube/config
          chmod 600 ~/.kube/config
      - name: Set app version
        run: 'sed -i "s/^appVersion:.*/appVersion: \"${GITHUB_SHA::7}\"/" charts/tracker/Chart.yaml'
      - name: Deploy tracker
        run: |
          helm upgrade --install tracker charts/tracker \
            --set image.repository=${{ env.IMAGE_PREFIX }}-tracker \
            --set image.tag=${{ github.sha }} \
            --set image.pullPolicy=Always \
            --set imagePullSecrets[0].name=ghcr-secret \
            --wait --timeout 5m
